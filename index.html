
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MusiChris App</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #151521; --secondary: #1E1E2C; --accent: #FFC312; --text: #ffffff; --danger: #ff4757; --dashed-border: #F79F1F; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background: var(--primary); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        input[type="file"] { display: none !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000 !important; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #252535; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); max-height: 85vh; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        
        #view-login { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 2000; background: var(--primary); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-card { background: var(--secondary); padding: 40px 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .logo-text { font-size: 2.2rem; font-weight: 700; margin-bottom: 20px; }
        .logo-text span { color: var(--accent); }
        .password-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: #252535; color: white; font-size: 1rem; }
        .pass-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; cursor: pointer; z-index: 10; font-size: 1.2rem; }
        .btn-login { width: 100%; padding: 15px; margin-top: 20px; border-radius: 12px; border: none; background: var(--accent); color: #1a1a2e; font-weight: 800; font-size: 1.1rem; cursor: pointer; }

        .view-section { display: none; height: 100%; width: 100%; overflow-y: auto; padding-bottom: 140px; opacity: 0; transition: opacity 0.3s; }
        .view-section.active { opacity: 1; }
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 15px; }
        .brand { font-size: 1.6rem; font-weight: 800; letter-spacing: -1px; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .btn-icon { background: rgba(255,255,255,0.08); border: none; width: 40px; height: 40px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .user-profile { display: flex; align-items: center; gap: 8px; background: var(--secondary); padding: 4px 12px 4px 4px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; border: 1px solid var(--accent); }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: var(--secondary); padding: 5px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.03); height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card h3 { font-size: 0.65rem; color: #aaa; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .value { font-size: 1.3rem; font-weight: bold; color: var(--accent); margin: 0; }

        .tabs { display: flex; width: 100%; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; text-align: center; background: var(--secondary); border: 1px solid rgba(255,255,255,0.05); color: #888; padding: 12px 0; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--accent); color: #1a1a2e; border-color: var(--accent); }
        .list-tab-content { display: none; }
        .list-tab-content.active { display: block; animation: fadeIn 0.4s; }

        .btn-dashed-style { display: block; width: 100%; padding: 18px; margin-bottom: 25px; margin-top: 5px; background: rgba(247, 159, 31, 0.05); color: var(--dashed-border); border: 2px dashed var(--dashed-border); border-radius: 14px; font-weight: 800; font-size: 1.1rem; text-align: center; cursor: pointer; position: relative; z-index: 10; }
        .btn-dashed-style:active { background: rgba(247, 159, 31, 0.15); transform: scale(0.98); }
        .announcement-box { cursor: default !important; text-align: left; }
        .announcement-box h3 { margin: 0 0 5px 0; font-size: 0.8rem; color: white; display: flex; align-items: center; gap: 5px; }
        .announcement-box p { margin: 0; color: #ccc; font-size: 0.9rem; font-weight: normal; }

        .song-list-item { display: flex; align-items: center; padding: 10px; background: var(--secondary); margin-bottom: 10px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.02); cursor: pointer; }
        .song-cover { width: 50px; height: 50px; border-radius: 10px; background-size: cover; background-position: center; margin-right: 15px; flex-shrink: 0; background-color: #333; position: relative; }
        .song-info { flex: 1; min-width: 0; }
        .song-title { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
        .song-artist { font-size: 0.8rem; color: #888; }
        .song-actions { display: flex; gap: 8px; align-items: center; }
        .btn-list-action { background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .playlist-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .collection-card { background: var(--secondary); border-radius: 18px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.03); position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .collection-cover { width: 200px; height: 200px; background-size: cover; background-position: center; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background-color: #333; }
        .collection-card h4 { margin: 0 0 10px 0; font-size: 1.2rem; color: white; white-space: normal; }
        .album-admin-tools { display: flex; gap: 15px; margin-top: auto; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); width: 100%; justify-content: center; }
        .btn-alb-tool { width: 35px; height: 35px; border-radius: 8px; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; }
        .pl-icon-bg { background-size: 40% !important; background-repeat: no-repeat !important; background-position: center !important; }
        .grad-1 { background: linear-gradient(135deg, #FF9F43 0%, #ff4757 100%); }
        .grad-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .grad-3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        .user-list-item { display: flex; justify-content: space-between; align-items: center; background: var(--secondary); padding: 12px 20px; border-radius: 12px; margin-bottom: 10px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        .btn-delete-user { background: var(--danger); width: 35px; height: 35px; border-radius: 8px; border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        #view-guest-player { background: linear-gradient(180deg, #252535 0%, #151521 100%); display: none; flex-direction: column; padding: 15px; z-index: 5000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        .guest-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 0; }
        #guestCover { width: 70vw; height: 70vw; max-width: 280px; max-height: 280px; border-radius: 20px; background-size: cover; background-position: center; box-shadow: 0 15px 40px rgba(0,0,0,0.6); margin: 10px 0; }
        .guest-info-area { text-align: center; width: 100%; margin: 10px 0; }
        .guest-info-area h2 { margin: 0 0 8px 0; font-size: 1.3rem; }
        .guest-info-area p { margin: 0; color: #aaa; font-size: 0.95rem; }
        .guest-controls-extra { display: flex; justify-content: space-around; width: 100%; margin: 10px 0; }
        .btn-guest-action { background: transparent; border: none; color: white; cursor: pointer; font-size: 1.5rem; padding: 5px; }
        .guest-controls-main { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 10px; margin: 10px 0; }
        #iconPlayBig { font-size: 3.5rem; }
        
        .progress-container { width: 100%; margin: 15px 0; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; height: 4px; border-radius: 5px; -webkit-appearance: none; background: #444; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; border: none; }
        .time-display { font-size: 0.8rem; color: #888; min-width: 35px; }
        .eq-band { display: flex; flex-direction: column; align-items: center; height: 100%; }
        .eq-slider { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 100px !important; flex: 1; }
        .eq-band label { font-size: 0.8rem; color: #aaa; margin-top: 10px; }

        .bottom-player { position: fixed; bottom: 0; left: 0; width: 100%; height: 90px; background: rgba(30, 30, 44, 0.98); border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 1000; transition: transform 0.3s ease-in-out; cursor: pointer; }
        .bottom-player.hidden { transform: translateY(100%); }
        .player-info { width: 25%; display: flex; align-items: center; gap: 12px; overflow: hidden; margin-right: 15px; }
        .player-info h4 { margin: 0; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-info p { margin: 0; font-size: 0.8rem; color: #aaa; }
        .player-center-group { width: 45%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .controls-row { display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 5px; }
        .btn-play-circle { width: 45px; height: 45px; background: white; border-radius: 50%; color: black; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        
        .player-right-group { width: 30%; display: flex; justify-content: flex-end; gap: 15px; color: #aaa; align-items: center; min-width: 150px; }
        .minimized-player-controls { display: none; }
        .small-icon { font-size: 1.2rem; color:#aaa; cursor: pointer; }
        .ctrl-icon { cursor: pointer; }

        .close-btn-x { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: #888; cursor: pointer; font-weight: bold; background: transparent; border: none; }
        #plDetailList { overflow-y: auto; flex: 1; margin-top: 15px; max-height: 50vh; }
        .form-input { width: 100%; padding: 12px; margin: 8px 0; background: #1a1a2e; border: 1px solid #333; color: white; border-radius: 8px; }
        .btn-submit { width: 100%; padding: 12px; background: var(--accent); color: #1a1a2e; border: none; border-radius: 8px; font-weight: 800; margin-top: 20px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .close-modal { background: transparent; border: 1px solid #666; color: #ddd; }

        .customToast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 15px 25px; border-radius: 10px; z-index: 9999; display: none; }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .brand { font-size: 1.3rem; }
            #adminNameDisplay, #userGreetingName { display: none; }
            .user-profile { background: transparent; border: none; padding: 0; }
            .header-right { gap: 8px; }
            .btn-icon { width: 35px; height: 35px; font-size: 1.1rem; }
            .card { height: 90px; } 
            .card h3 { font-size: 0.6rem; } 
            .card .value { font-size: 1.1rem; }
            .playlist-grid { grid-template-columns: 1fr !important; }
            .collection-cover { width: 180px; height: 180px; }
            .player-center-group, .player-right-group { display: none !important; }
            .minimized-player-controls { display: flex !important; align-items: center; gap: 20px; }
            .minimized-player-controls span { font-size: 2.2rem !important; color: white; }
            #iconPlayMin { color: var(--accent); font-size: 2.8rem !important; }
            .bottom-player { padding: 0 20px !important; height: 85px !important; }
            .player-info { width: 55%; }
            
            #guestCover { width: 65vw; height: 65vw; max-width: 240px; max-height: 240px; margin: 5px 0; }
            .guest-info-area h2 { font-size: 1.1rem; }
            .guest-info-area p { font-size: 0.85rem; }
            .btn-guest-action { font-size: 1.3rem !important; padding: 3px; }
            #iconPlayBig { font-size: 3rem !important; }
            .guest-controls-main { padding: 0 5px; }
            .guest-container { padding: 5px 0; }
            #view-guest-player { padding: 10px; }
        }
        
        @media (max-width: 375px) {
            #guestCover { width: 60vw; height: 60vw; max-width: 200px; max-height: 200px; }
            .guest-info-area h2 { font-size: 1rem; }
            .btn-guest-action { font-size: 1.2rem !important; }
            #iconPlayBig { font-size: 2.8rem !important; }
        }
    </style>
</head>
<body>

    <div id="view-login">
        <div class="login-card">
            <div class="logo-text">Musi<span>Chris</span> üéµ</div>
            <p style="color:#aaa; margin-bottom:20px">Bienvenido</p>
            <input type="email" id="loginEmail" class="login-input" placeholder="Usuario o Email">
            <div class="password-wrapper">
                <input type="password" id="loginPass" class="login-input" placeholder="Contrase√±a">
                <span class="material-icons-round pass-toggle" id="btnTogglePass">visibility_off</span>
            </div>
            <button id="btnLoginBtn" class="btn-login">Ingresar</button>
        </div>
    </div>

    <div id="view-admin" class="view-section">
        <div class="container">
            <header>
                <div class="brand">MusiChris <span>Admin</span></div>
                <div class="header-right">
                    <button class="btn-icon" onclick="openModal('dom_modal_announcement')"><span class="material-icons-round">campaign</span></button>
                    <button class="btn-icon" onclick="openModal('dom_modal_settings')"><span class="material-icons-round">settings</span></button>
                    <div class="user-profile" onclick="openProfile()">
                        <img id="adminAvatar" src="" class="avatar">
                        <span id="adminNameDisplay">Admin</span>
                    </div>
                    <button class="btn-icon btn-logout" onclick="app_logout()"><span class="material-icons-round">logout</span></button>
                </div>
            </header>

            <div class="stats-grid">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                        <h3 style="margin:0">Canciones</h3>
                        <span class="material-icons-round" onclick="openModal('dom_modal_date_filter')" style="cursor:pointer; color:var(--accent); font-size:1.2rem;">calendar_today</span>
                    </div>
                    <span class="material-icons-round" style="color:#e67e22; margin:5px 0;">library_music</span>
                    <div class="value" id="statsTotalSongs">0</div>
                </div>
                <div class="card"><h3>Usuarios</h3><span class="value" id="statsTotalUsers">0</span></div>
                <div class="card"><h3>Nube (25GB)</h3><div class="value" id="statsCloud">0%</div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('admin-music', this)">M√∫sica</button>
                <button class="tab-btn" onclick="switchTab('admin-playlists', this)">Playlist</button>
                <button class="tab-btn" onclick="switchTab('admin-albums', this)">√Ålbum</button>
                <button class="tab-btn" onclick="switchTab('admin-users', this)">Usuarios</button>
            </div>

            <div id="admin-music" class="list-tab-content active">
                <div class="btn-dashed-style" onclick="openUpload()">+ Subir Canci√≥n</div>
                <div style="background:#252535; padding:10px; border-radius:12px; margin-bottom:15px; display:flex; align-items:center;">
                    <span class="material-icons-round" style="color:#aaa; margin-right:10px;">search</span>
                    <input type="text" id="searchInputAdmin" placeholder="Buscar canci√≥n..." style="background:transparent; border:none; color:white; width:100%; outline:none;">
                </div>
                <div id="adminSongList"></div>
            </div>

            <div id="admin-playlists" class="list-tab-content">
                <div class="btn-dashed-style" onclick="doCreatePlaylist()">+ Nueva Playlist</div>
                <div id="adminPlaylistGrid" class="playlist-grid"></div>
            </div>
            
            <div id="admin-albums" class="list-tab-content">
                <div class="btn-dashed-style" onclick="openModal('dom_modal_album')">+ Nuevo √Ålbum</div>
                <div id="adminAlbumGrid" class="playlist-grid"></div>
            </div>
            
            <div id="admin-users" class="list-tab-content">
                <div class="btn-dashed-style" onclick="openModal('dom_modal_new_user')">+ Nuevo Usuario</div>
                <div id="usersListGrid"></div>
            </div>
        </div>
    </div>

    <div id="view-user" class="view-section">
        <div class="container">
            <header>
                <div class="brand">Musi<span>Chris</span></div>
                <div class="header-right">
                    <div class="user-profile" onclick="openProfile()">
                        <img id="userAvatarImg" src="" class="avatar">
                        <span id="userGreeting">Hola</span>
                    </div>
                    <button class="btn-icon" onclick="app_logout()"><span class="material-icons-round">logout</span></button>
                </div>
            </header>
            <div id="userAnnouncement" class="btn-dashed-style announcement-box" style="display:none;">
                <h3 style="color:var(--accent);">üì¢ Noticias</h3>
                <p id="announcementText"></p>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('user-music', this)">M√∫sica</button>
                <button class="tab-btn" onclick="switchTab('user-playlists', this)">Playlist</button>
                <button class="tab-btn" onclick="switchTab('user-albums', this)">√Ålbum</button>
            </div>
            <div id="user-music" class="list-tab-content active">
                <div style="background:#252535; padding:10px; border-radius:12px; margin-bottom:15px; display:flex; align-items:center;">
                    <span class="material-icons-round" style="color:#aaa; margin-right:10px;">search</span>
                    <input type="text" id="searchInputUser" placeholder="Buscar canci√≥n..." style="background:transparent; border:none; color:white; width:100%; outline:none;">
                </div>
                <div id="userSongList"></div>
            </div>
            <div id="user-playlists" class="list-tab-content">
                <div id="userPlaylistGrid" class="playlist-grid"></div>
            </div>
            <div id="user-albums" class="list-tab-content">
                <div id="userAlbumGrid" class="playlist-grid"></div>
            </div>
        </div>
    </div>

    <div id="mainPlayer" class="bottom-player" style="display:none;" onclick="openFullScreenPlayer()">
        <div class="player-info">
            <img id="pCoverMini" src="" style="width:45px; height:45px; border-radius:8px; object-fit:cover; background:#333;">
            <div style="overflow:hidden;">
                <h4 id="pTitle">T√≠tulo</h4>
                <p id="pArtist">Artista</p>
            </div>
        </div>
        <div class="player-center-group">
            <div class="controls-row">
                <span class="material-icons-round ctrl-icon small-icon" onclick="event.stopPropagation(); toggleShuffle()">shuffle</span>
                <span class="material-icons-round ctrl-icon" onclick="event.stopPropagation(); prev()">skip_previous</span>
                <div class="btn-play-circle" onclick="event.stopPropagation(); toggle_play()">
                    <span id="iconPlay" class="material-icons-round">play_arrow</span>
                </div>
                <span class="material-icons-round ctrl-icon" onclick="event.stopPropagation(); next()">skip_next</span>
                <span class="material-icons-round ctrl-icon small-icon" onclick="event.stopPropagation(); toggleRepeat()">repeat</span>
            </div>
            <input type="range" id="seekSlider" value="0" min="0" max="100" onclick="event.stopPropagation()">
        </div>
        <div class="player-right-group">
            <span class="material-icons-round small-icon" id="pLikeBtn" onclick="event.stopPropagation(); toggleLikeCurrent()">favorite_border</span>
            <span class="material-icons-round small-icon" onclick="event.stopPropagation(); openModal('dom_modal_eq')">graphic_eq</span>
            <span class="material-icons-round small-icon" onclick="event.stopPropagation(); openFullScreenPlayer()" style="font-size:1.5rem">open_in_full</span>
            <span class="material-icons-round small-icon" onclick="event.stopPropagation(); closePlayer()" style="color:var(--danger)">close</span>
        </div>
        <div class="minimized-player-controls">
            <span class="material-icons-round" onclick="event.stopPropagation(); openFullScreenPlayer()" style="font-size:2rem; margin-right:10px;">expand_less</span>
            <span id="iconPlayMin" class="material-icons-round" onclick="event.stopPropagation(); toggle_play()">play_arrow</span>
            <span class="material-icons-round" onclick="event.stopPropagation(); closePlayer()" style="color:var(--danger)">close</span>
        </div>
    </div>

    <div id="view-guest-player">
        <div style="display:flex; justify-content:space-between; width:100%; padding:5px 10px; align-items: center;">
            <span class="material-icons-round btn-guest-action" onclick="closeGuestMode()" style="font-size:1.8rem;">keyboard_arrow_down</span>
            <span style="color:#aaa; font-size:0.85rem; letter-spacing:1px;">REPRODUCIENDO</span>
            <span class="material-icons-round btn-guest-action" onclick="openModal('dom_modal_eq')" style="font-size:1.5rem;">graphic_eq</span>
        </div>
        <div class="guest-container">
            <div id="guestCover"></div>
            <div class="guest-info-area">
                <h2 id="guestTitle">T√≠tulo</h2>
                <p id="guestArtist">Artista</p>
            </div>
            <div class="guest-controls-extra">
                <span class="material-icons-round btn-guest-action" onclick="shareCurrentSong()">share</span>
                <div id="guestLikeBtn" onclick="toggleLikeCurrent()">
                    <span class="material-icons-round btn-guest-action">favorite_border</span>
                </div>
                <span class="material-icons-round btn-guest-action" style="opacity:0.3;">bedtime</span>
            </div>
            <div class="guest-controls-main"></div>
        </div>
    </div>

    <div id="dom_modal_upload" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_upload')">√ó</button>
            <h3 id="modalUploadTitle" style="margin-top:0">Subir Canci√≥n</h3>
            <input type="text" id="upTitle" class="form-input" placeholder="T√≠tulo">
            <input type="text" id="upGenre" class="form-input" placeholder="Artista / G√©nero">
            <select id="upAlbum" class="form-input" style="background:#1a1a2e;color:#aaa">
                <option value="">Sin √Ålbum</option>
            </select>
            <input type="text" id="upUrl" class="form-input" placeholder="Enlace MP3">
            <div class="modal-footer" style="display:flex;gap:10px;margin-top:20px;">
                <button class="close-modal" onclick="closeModal('dom_modal_upload')" style="flex:1;padding:12px;border-radius:8px;cursor:pointer;">Cancelar</button>
                <button id="btnUploadSubmit" class="btn-submit" style="flex:2;margin:0;" onclick="do_upload()">Subir</button>
            </div>
        </div>
    </div>
    
    <div id="dom_modal_album" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_album')">√ó</button>
            <h3>Nuevo √Ålbum</h3>
            <input type="text" id="newAlbName" class="form-input" placeholder="Nombre">
            <input type="text" id="newAlbArtist" class="form-input" placeholder="Artista">
            <div style="margin:10px 0; border:1px dashed #555; padding:10px; border-radius:10px;">
                <label for="newAlbCoverFile" style="color:var(--accent); cursor:pointer;">üìÇ Portada</label>
                <input type="file" id="newAlbCoverFile" accept="image/*" onchange="previewFile(this, 'newAlbCoverUrl')">
            </div>
            <input type="text" id="newAlbCoverUrl" class="form-input" placeholder="O enlace...">
            <button class="btn-submit" onclick="do_create_album()">Crear</button>
        </div>
    </div>
    
    <div id="dom_modal_new_user" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_new_user')">√ó</button>
            <h3>Registrar Usuario</h3>
            <input type="text" id="newUser_Name" class="form-input" placeholder="Nombre">
            <input type="email" id="newUser_Email" class="form-input" placeholder="Email">
            <input type="password" id="newUser_Pass" class="form-input" placeholder="Contrase√±a">
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button class="close-modal" onclick="closeModal('dom_modal_new_user')" style="flex:1;padding:12px;border-radius:8px;cursor:pointer;">Cancelar</button>
                <button class="btn-submit" style="flex:2;margin:0;" onclick="do_create_user_modal()">Registrar</button>
            </div>
        </div>
    </div>
    
    <div id="dom_modal_pl_detail" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_pl_detail')">√ó</button>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 id="plDetailTitle" style="margin:0">Lista</h3>
                <button class="btn-submit" style="margin:0; width:auto; padding:8px 15px;" onclick="playCollection()">Reproducir Todo</button>
            </div>
            <div id="plDetailList"></div>
        </div>
    </div>
    
    <div id="dom_modal_profile" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_profile')">√ó</button>
            <h3>Mi Perfil</h3>
            <div style="text-align:center;margin-bottom:15px;">
                <img id="profilePreview" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);">
                <br>
                <button style="background:transparent;border:1px solid #555;color:#ccc;padding:5px 10px;border-radius:15px;margin-top:10px;cursor:pointer;" onclick="changeAvatar()">Cambiar Avatar</button>
            </div>
            <input type="text" id="profileName" class="form-input" placeholder="Nombre">
            <input type="email" id="profileEmail" class="form-input" disabled style="opacity:0.5" placeholder="Email">
            <button class="btn-submit" onclick="do_save_profile()">Guardar</button>
        </div>
    </div>
    
    <div id="dom_modal_announcement" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_announcement')">√ó</button>
            <h3>Publicar Noticia</h3>
            <textarea id="announcementInput" class="form-input" rows="4" placeholder="Mensaje..."></textarea>
            <button class="btn-submit" onclick="do_save_announce()">Publicar</button>
        </div>
    </div>
    
    <div id="dom_modal_settings" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_settings')">√ó</button>
            <h3>Configuraci√≥n</h3>
            <label style="color:#aaa; font-size:0.85rem;">BIN ID:</label>
            <input type="text" id="cfgBinId" class="form-input" disabled>
            <label style="color:#aaa; font-size:0.85rem;">API KEY:</label>
            <input type="password" id="cfgApiKey" class="form-input" disabled>
            <button class="btn-submit" onclick="closeModal('dom_modal_settings')">Cerrar</button>
        </div>
    </div>
    
    <div id="dom_modal_edit_album" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn-x" onclick="closeModal('dom_modal_edit_album')">√ó</button>
            <h3>Editar √Ålbum</h3>
            <input type="text" id="editAlbName" class="form-input" placeholder="Nombre">
            <input type="text" id="editAlbArtist" class="form-input" placeholder="Artista">
            <div style="margin:10px 0; border:1px dashed #555; padding:10px; border-radius:10px;">
                <label for="editAlbCoverFile" style="color:var(--accent); cursor:pointer;">üìÇ Cambiar Portada</label>
                <input type="file" id="editAlbCoverFile" accept="image/*" onchange="previewFile(this, 'editAlbCover')">
            </div>
            <input type="text" id="editAlbCover" class="form-input" placeholder="URL Portada">
            <button class="btn-submit" onclick="doSaveEditAlbum()">Guardar</button>
        </div>
    </div>
    
    <div id="dom_modal_date_filter" class="modal-overlay">
        <div class="modal-content" style="max-width:300px">
            <button class="close-btn-x" onclick="closeModal('dom_modal_date_filter')">√ó</button>
            <h2>Filtrar Fecha</h2>
            <label style="color:#aaa; font-size:0.9rem;">Desde:</label>
            <input type="date" id="filterStart" class="form-input" style="color-scheme:dark">
            <label style="color:#aaa; font-size:0.9rem;">Hasta:</label>
            <input type="date" id="filterEnd" class="form-input" style="color-scheme:dark">
            <button class="btn-submit" onclick="applyDateFilter()">Aplicar</button>
            <button class="btn-submit" onclick="clearDateFilter()" style="background:transparent;border:1px solid #555;margin-top:5px">Limpiar</button>
            <button class="close-modal" onclick="closeModal('dom_modal_date_filter')" style="width:100%; padding:12px; border-radius:8px; cursor:pointer; margin-top:5px;">Cerrar</button>
        </div>
    </div>
    
    <div id="dom_modal_eq" class="modal-overlay">
        <div class="modal-content" style="max-width:320px; text-align:center">
            <button class="close-btn-x" onclick="closeModal('dom_modal_eq')">√ó</button>
            <h3>Ecualizador üéõÔ∏è</h3>
            <div style="display:flex; justify-content:space-around; height:150px; align-items:center; margin:20px 0">
                <div class="eq-band">
                    <input type="range" orient="vertical" min="-10" max="10" value="0" class="eq-slider">
                    <label>Bajos</label>
                </div>
                <div class="eq-band">
                    <input type="range" orient="vertical" min="-10" max="10" value="0" class="eq-slider">
                    <label>Medios</label>
                </div>
                <div class="eq-band">
                    <input type="range" orient="vertical" min="-10" max="10" value="0" class="eq-slider">
                    <label>Agudos</label>
                </div>
            </div>
            <button class="close-modal" onclick="closeModal('dom_modal_eq')" style="width:100%; padding:12px; border-radius:8px; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <div id="customToast" class="customToast">Mensaje</div>

    <script>
        const API_BASE_URL = "https://api.jsonbin.io/v3/b/";
        const DEFAULT_COVER = "https://i.ibb.co/3WqP7tX/default-cover.png";
        const PERMANENT_BIN_ID = "69349a76ae596e708f880e31";
        const PERMANENT_API_KEY = "$2a$10$ME7fO8Oqq2iWhHkYQKGQsu0M6PqJ8d1ymFBxHVhhxFJ70BcAg1FZe";
        const ADMIN_AVATAR = "https://api.dicebear.com/7.x/avataaars/svg?seed=Chris";

        let appConfig = {
            BIN_ID: PERMANENT_BIN_ID,
            API_KEY: PERMANENT_API_KEY,
            data: null,
            user: null,
            isLoggedIn: false,
            isAdmin: false,
            currentSong: null,
            tempPlaylist: [],
            editingAlbumIndex: null,
            pendingSongId: null,
            isGuest: false,
            editingSongId: null,
            isShuffle: false,
            isRepeat: false,
            currentIndex: 0
        };

        const dom = {};
        const norm = (str) => (str || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('customToast');
            if (toast) {
                toast.textContent = msg;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 2500);
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(v => {
                v.style.display = 'none';
                v.classList.remove('active');
            });
            const view = document.getElementById(viewId);
            if (view) {
                view.style.display = 'block';
                setTimeout(() => view.classList.add('active'), 10);
            }
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-guest-player').style.display = 'none';
        }

        window.handleLoginAttempt = async function() {
            const emailEl = document.getElementById('loginEmail');
            const passEl = document.getElementById('loginPass');
            if (!emailEl || !passEl) { 
                alert("Error interno de campos"); 
                return; 
            }
            
            const email = emailEl.value.trim().toLowerCase();
            const pass = passEl.value.trim();

            if (email === 'hjalmar' && pass === '258632') { 
                doLogin({ name: 'Hjalmar', email: 'admin@musichris.com', role: 'admin', avatar: ADMIN_AVATAR }); 
                return; 
            }
            
            if (!appConfig.data) {
                showToast("Conectando...", 'info');
                await loadAppData();
            }
            
            const user = appConfig.data?.users?.find(u => u.email.toLowerCase() === email);
            if (user && pass === (user.password || '123')) {
                doLogin(user);
            } else {
                showToast("Credenciales incorrectas", 'error');
            }
        }

        function doLogin(user) {
            appConfig.user = user;
            appConfig.isLoggedIn = true;
            appConfig.isAdmin = (user.role === 'admin');
            localStorage.setItem('appConfig', JSON.stringify({
                user, 
                isLoggedIn: true, 
                isAdmin: appConfig.isAdmin
            }));
            showView(appConfig.isAdmin ? 'view-admin' : 'view-user');
            loadAppData();
        }

        async function loadAppData() {
            try {
                const res = await fetch(`${API_BASE_URL}${PERMANENT_BIN_ID}`, {
                    headers: {'X-Master-Key': PERMANENT_API_KEY}
                });
                if (!res.ok) throw new Error("API Error");
                const json = await res.json();
                appConfig.data = json.record;
                
                if (!appConfig.data.songs) appConfig.data.songs = [];
                if (!appConfig.data.users) appConfig.data.users = [];
                if (!appConfig.data.albums) appConfig.data.albums = [];
                if (!appConfig.data.playlists) appConfig.data.playlists = [];
                
                appConfig.data.songs.forEach(s => {
                    if (!s.likes) s.likes = [];
                    if (!s.plays) s.plays = 0;
                });
                
                if (appConfig.isGuest && appConfig.pendingSongId) {
                    activateGuestMode();
                } else {
                    updateUI();
                }
                
                showToast("Datos cargados", 'success');
            } catch(e) {
                console.error(e);
                showToast("Error de conexi√≥n", 'error');
                
                appConfig.data = {
                    songs: [
                        { id: 1, title: "Canci√≥n Demo", genre: "Demo Artist", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", plays: 10, likes: [], cover: DEFAULT_COVER }
                    ],
                    users: [],
                    albums: [],
                    playlists: []
                };
                updateUI();
            }
        }

        function updateUI(songListOverride = null) {
            if (document.getElementById('statsTotalSongs') && appConfig.data) {
                document.getElementById('statsTotalSongs').textContent = appConfig.data.songs.length;
            }
            if (document.getElementById('statsTotalUsers') && appConfig.data) {
                document.getElementById('statsTotalUsers').textContent = appConfig.data.users.length;
            }
            if (document.getElementById('statsCloud') && appConfig.data) {
                const pct = Math.min((appConfig.data.songs.length * 5 / 25000) * 100, 100).toFixed(1);
                document.getElementById('statsCloud').textContent = pct + "%";
            }
            
            const songs = songListOverride || appConfig.data.songs;
            renderSongList(appConfig.isAdmin ? 'adminSongList' : 'userSongList', songs);
            renderAlbumGrid(appConfig.isAdmin ? 'adminAlbumGrid' : 'userAlbumGrid', appConfig.data.albums);
            renderSmartPlaylists(appConfig.isAdmin ? 'adminPlaylistGrid' : 'userPlaylistGrid');
            
            if (appConfig.isAdmin) {
                renderUserList('usersListGrid', appConfig.data.users);
            }
            
            if (appConfig.user) {
                if (document.getElementById('adminAvatar')) 
                    document.getElementById('adminAvatar').src = appConfig.user.avatar || ADMIN_AVATAR;
                if (document.getElementById('userAvatarImg')) 
                    document.getElementById('userAvatarImg').src = appConfig.user.avatar || ADMIN_AVATAR;
                if (document.getElementById('adminNameDisplay')) 
                    document.getElementById('adminNameDisplay').textContent = appConfig.user.name;
                if (document.getElementById('userGreeting')) 
                    document.getElementById('userGreeting').textContent = `Hola ${appConfig.user.name}`;
            }
            
            const cfgBinId = document.getElementById('cfgBinId');
            const cfgApiKey = document.getElementById('cfgApiKey');
            if (cfgBinId) cfgBinId.value = PERMANENT_BIN_ID;
            if (cfgApiKey) cfgApiKey.value = PERMANENT_API_KEY;
            
            if (document.getElementById('userAnnouncement') && document.getElementById('announcementText') && appConfig.data.announcement) {
                document.getElementById('userAnnouncement').style.display = 'block';
                document.getElementById('announcementText').textContent = appConfig.data.announcement;
            } else if (document.getElementById('userAnnouncement')) {
                document.getElementById('userAnnouncement').style.display = 'none';
            }
        }

        function renderSongList(id, songs) {
            const c = document.getElementById(id);
            if (!c) return;
            c.innerHTML = '';
            
            songs.forEach((s) => {
                const div = document.createElement('div');
                div.className = 'song-list-item';
                const art = getSongArt(s);
                
                let adminBtns = '';
                if (appConfig.isAdmin) {
                    adminBtns = `
                        <button class="btn-list-action" style="margin-right:5px;background:rgba(255,255,255,0.1)" onclick="event.stopPropagation(); editSong(event,${s.id})">
                            <span class="material-icons-round" style="font-size:1rem">edit</span>
                        </button>
                        <button class="btn-list-action" style="background:var(--danger)" onclick="event.stopPropagation(); deleteSong(event,${s.id})">
                            <span class="material-icons-round" style="font-size:1rem">delete</span>
                        </button>
                    `;
                }
                
                div.innerHTML = `
                    <div class="song-cover" style="background-image:url('${art}')"></div>
                    <div class="song-info">
                        <div class="song-title">${s.title}</div>
                        <div class="song-artist">${s.genre}</div>
                    </div>
                    <div class="song-actions">
                        <button class="btn-list-action" onclick="event.stopPropagation(); playSongId(${s.id})">
                            <span class="material-icons-round">play_arrow</span>
                        </button>
                        ${adminBtns}
                    </div>
                `;
                
                div.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    playSong(s);
                };
                
                c.appendChild(div);
            });
        }

        function getSongArt(song) {
            let art = song.cover || song.img || song.image;
            if (art && !art.includes("imgbb") && !art.includes("image not found")) return art;
            
            if (song.album && appConfig.data && appConfig.data.albums) {
                const target = norm(song.album);
                const album = appConfig.data.albums.find(a => 
                    norm(a.title || a.name).includes(target) || target.includes(norm(a.title || a.name))
                );
                if (album) return getArt(album);
            }
            return DEFAULT_COVER;
        }

        function getArt(item) {
            if (!item) return DEFAULT_COVER;
            const url = item.cover || item.img || item.image || item.coverUrl;
            return url || DEFAULT_COVER;
        }

        window.playSongId = function(id) {
            const song = appConfig.data.songs.find(s => s.id === id);
            if (song) playSong(song);
        }

        function playSong(song) {
            console.log('Playing song:', song);
            
            appConfig.currentSong = song;
            appConfig.tempPlaylist = appConfig.data.songs;
            appConfig.currentIndex = appConfig.data.songs.findIndex(s => s.id === song.id);
            
            const mainPlayer = document.getElementById('mainPlayer');
            if (mainPlayer) {
                mainPlayer.style.display = 'flex';
                mainPlayer.classList.remove('hidden');
            }
            
            if (dom.audioElement) dom.audioElement.pause();
            appConfig.currentSong = null;
            closeFullScreenPlayer();
        };

        function updateProgress() {
            const au = dom.audioElement;
            if (!au || isNaN(au.duration)) return;
            
            const pct = (au.currentTime / au.duration) * 100;
            
            if (document.getElementById('seekSlider')) 
                document.getElementById('seekSlider').value = pct;
            
            const expSlider = document.getElementById('expandedSeekSlider');
            const curTime = document.getElementById('expCurTime');
            const totTime = document.getElementById('expTotTime');
            
            if (expSlider) expSlider.value = pct;
            if (curTime) curTime.textContent = formatTime(au.currentTime);
            if (totTime) totTime.textContent = formatTime(au.duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function seekAudio(e) {
            if (!dom.audioElement) return;
            dom.audioElement.currentTime = dom.audioElement.duration * (e.target.value / 100);
        }

        window.toggleLikeCurrent = async function() {
            if (appConfig.isGuest) {
                showToast("Inicia sesi√≥n para agregar favoritos", 'info');
                return;
            }
            
            if (!appConfig.currentSong || !appConfig.user) return;
            
            const song = appConfig.data.songs.find(s => s.id === appConfig.currentSong.id);
            if (!song) return;
            
            if (!song.likes) song.likes = [];
            
            const email = appConfig.user.email;
            const index = song.likes.indexOf(email);
            
            if (index > -1) {
                song.likes.splice(index, 1);
                showToast("Eliminado de favoritos", 'info');
            } else {
                song.likes.push(email);
                showToast("A√±adido a favoritos", 'success');
            }
            
            await saveData();
            updateLikeIcon();
        };

        function updateLikeIcon() {
            if (!appConfig.currentSong || !appConfig.user) return;
            
            const song = appConfig.data.songs.find(s => s.id === appConfig.currentSong.id);
            if (!song || !song.likes) return;
            
            const isLiked = song.likes.includes(appConfig.user.email);
            const icon = isLiked ? 'favorite' : 'favorite_border';
            
            const pLikeBtn = document.getElementById('pLikeBtn');
            if (pLikeBtn) pLikeBtn.textContent = icon;
            
            const guestLikeBtn = document.querySelector('#guestLikeBtn span');
            if (guestLikeBtn) guestLikeBtn.textContent = icon;
        }

        window.shareCurrentSong = async function() {
            if (!appConfig.currentSong) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?s=${appConfig.currentSong.id}`;
            const textMsg = `Encontr√© la canci√≥n ${appConfig.currentSong.title} en la app MusiChris. Te la recomiendo: ${shareUrl}`;
            
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'MusiChris',
                        text: textMsg
                    });
                } else {
                    await navigator.clipboard.writeText(textMsg);
                    showToast("Enlace copiado", 'success');
                }
            } catch(e) {
                console.error('Share error:', e);
            }
        };

        window.openUpload = function() {
            appConfig.editingSongId = null;
            document.getElementById('modalUploadTitle').textContent = "Subir Canci√≥n";
            document.getElementById('btnUploadSubmit').textContent = "Subir";
            document.getElementById('upTitle').value = '';
            document.getElementById('upGenre').value = '';
            document.getElementById('upUrl').value = '';
            
            // FIX: Poblar select de √°lbumes correctamente
            const sel = document.getElementById('upAlbum');
            sel.innerHTML = '<option value="">Sin √Ålbum</option>';
            if (appConfig.data && appConfig.data.albums && appConfig.data.albums.length > 0) {
                appConfig.data.albums.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.title || a.name;
                    opt.textContent = a.title || a.name;
                    sel.appendChild(opt);
                });
            }
            
            openModal('dom_modal_upload');
        };

        window.do_upload = async function() {
            const title = document.getElementById('upTitle').value.trim();
            const url = document.getElementById('upUrl').value.trim();
            
            if (!title) return showToast("Falta t√≠tulo", 'error');
            if (!url && !appConfig.editingSongId) return showToast("Falta URL", 'error');
            
            showToast("Guardando...", 'info');
            
            if (appConfig.editingSongId) {
                const idx = appConfig.data.songs.findIndex(s => s.id === appConfig.editingSongId);
                if (idx !== -1) {
                    appConfig.data.songs[idx].title = title;
                    appConfig.data.songs[idx].genre = document.getElementById('upGenre').value;
                    appConfig.data.songs[idx].album = document.getElementById('upAlbum').value;
                    if (url) appConfig.data.songs[idx].url = url;
                    showToast("Actualizado", 'success');
                }
            } else {
                appConfig.data.songs.push({
                    id: Date.now(),
                    title,
                    genre: document.getElementById('upGenre').value,
                    album: document.getElementById('upAlbum').value,
                    url: url,
                    plays: 0,
                    likes: []
                });
                showToast("Subido", 'success');
            }
            
            await saveData();
            updateUI();
            closeModal('dom_modal_upload');
        };

        window.editSong = function(e, id) {
            e.stopPropagation();
            const song = appConfig.data.songs.find(s => s.id === id);
            if (!song) return;
            
            appConfig.editingSongId = id;
            document.getElementById('modalUploadTitle').textContent = "Editar Canci√≥n";
            document.getElementById('btnUploadSubmit').textContent = "Guardar";
            document.getElementById('upTitle').value = song.title;
            document.getElementById('upGenre').value = song.genre;
            document.getElementById('upUrl').value = song.url || '';
            
            // FIX: Poblar select de √°lbumes correctamente al editar
            const sel = document.getElementById('upAlbum');
            sel.innerHTML = '<option value="">Sin √Ålbum</option>';
            if (appConfig.data && appConfig.data.albums && appConfig.data.albums.length > 0) {
                appConfig.data.albums.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.title || a.name;
                    opt.textContent = a.title || a.name;
                    sel.appendChild(opt);
                });
            }
            sel.value = song.album || "";
            
            openModal('dom_modal_upload');
        };

        window.deleteSong = async function(e, id) {
            e.stopPropagation();
            if (!confirm("¬øEliminar esta canci√≥n?")) return;
            
            const idx = appConfig.data.songs.findIndex(s => s.id === id);
            if (idx !== -1) {
                appConfig.data.songs.splice(idx, 1);
                await saveData();
                updateUI();
                showToast("Canci√≥n eliminada", 'success');
            }
        };

        function renderAlbumGrid(id, albums) {
            const c = document.getElementById(id);
            if (!c) return;
            c.innerHTML = '';
            
            albums.forEach((a, index) => {
                const div = document.createElement('div');
                div.className = 'collection-card';
                const art = getArt(a);
                
                let adminBtns = '';
                if (appConfig.isAdmin) {
                    adminBtns = `
                        <div class="album-admin-tools">
                            <button class="btn-alb-tool" style="background:#333" onclick="event.stopPropagation(); editAlbum(event,${index})">‚úèÔ∏è</button>
                            <button class="btn-alb-tool" style="background:var(--danger)" onclick="event.stopPropagation(); deleteAlbum(event,${index})">üóëÔ∏è</button>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="collection-cover" style="background-image:url('${art}')"></div>
                    <h4>${a.title || a.name}</h4>
                    ${adminBtns}
                `;
                
                div.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    openAlbumDetail(a);
                };
                
                c.appendChild(div);
            });
        }

        function openAlbumDetail(album) {
            const target = norm(album.title || album.name);
            let songs = appConfig.data.songs.filter(s => s.album && norm(s.album) === target);
            appConfig.tempPlaylist = songs;
            
            document.getElementById('plDetailTitle').textContent = album.title || album.name;
            
            const list = document.getElementById('plDetailList');
            list.innerHTML = '';
            
            if (songs.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:20px;color:#888">√Ålbum vac√≠o.</div>';
            } else {
                songs.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'song-list-item';
                    item.innerHTML = `
                        <div class="song-info">
                            <div class="song-title">${s.title}</div>
                            <div class="song-artist">${s.genre}</div>
                        </div>
                        <span class="material-icons-round" style="color:var(--accent)">play_circle</span>
                    `;
                    item.onclick = () => {
                        playSong(s);
                        closeModal('dom_modal_pl_detail');
                    };
                    list.appendChild(item);
                });
            }
            
            openModal('dom_modal_pl_detail');
        }

        function renderSmartPlaylists(id) {
            const c = document.getElementById(id);
            if (!c) return;
            c.innerHTML = '';
            
            const createCard = (t, img, grad, fn) => {
                const d = document.createElement('div');
                d.className = 'collection-card';
                d.innerHTML = `
                    <div class="collection-cover pl-icon-bg ${grad}" style="background-image:url('${img}')"></div>
                    <h4>${t}</h4>
                `;
                d.onclick = fn;
                return d;
            };
            
            c.appendChild(createCard(
                "Favoritos", 
                "https://cdn-icons-png.flaticon.com/512/833/833472.png", 
                "grad-1", 
                () => openSmartList('fav')
            ));
            
            c.appendChild(createCard(
                "Recientes", 
                "https://cdn-icons-png.flaticon.com/512/2972/2972531.png", 
                "grad-2", 
                () => openSmartList('recent')
            ));
            
            c.appendChild(createCard(
                "Top Hits", 
                "https://cdn-icons-png.flaticon.com/512/651/651717.png", 
                "grad-3", 
                () => openSmartList('top')
            ));
            
            if (appConfig.data.playlists) {
                appConfig.data.playlists.forEach(pl => {
                    const d = document.createElement('div');
                    d.className = 'collection-card';
                    d.innerHTML = `
                        <div class="collection-cover pl-icon-bg grad-2" style="background-image:url('https://cdn-icons-png.flaticon.com/512/1179/1179069.png')"></div>
                        <h4>${pl.name}</h4>
                    `;
                    d.onclick = () => showToast("Lista vac√≠a", 'info');
                    c.appendChild(d);
                });
            }
        }

        function openSmartList(type) {
            let songs = [];
            let title = "";
            
            if (type === 'fav') {
                title = "Favoritos";
                const email = appConfig.user.email;
                songs = appConfig.data.songs.filter(s => s.likes && s.likes.includes(email));
            } else if (type === 'recent') {
                title = "Recientes";
                songs = [...appConfig.data.songs].sort((a, b) => b.id - a.id).slice(0, 15);
            } else if (type === 'top') {
                title = "Top Hits";
                songs = [...appConfig.data.songs].sort((a, b) => (b.plays || 0) - (a.plays || 0)).slice(0, 20);
            }
            
            appConfig.tempPlaylist = songs;
            document.getElementById('plDetailTitle').textContent = title;
            
            const list = document.getElementById('plDetailList');
            list.innerHTML = '';
            
            songs.forEach(s => {
                const item = document.createElement('div');
                item.className = 'song-list-item';
                item.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${s.title}</div>
                    </div>
                    <span class="material-icons-round" style="color:var(--accent)">play_circle</span>
                `;
                item.onclick = () => {
                    playSong(s);
                    closeModal('dom_modal_pl_detail');
                };
                list.appendChild(item);
            });
            
            openModal('dom_modal_pl_detail');
        }

        window.playCollection = () => {
            if (appConfig.tempPlaylist && appConfig.tempPlaylist[0]) {
                playSong(appConfig.tempPlaylist[0]);
                closeModal('dom_modal_pl_detail');
            }
        };

        window.doCreatePlaylist = function() {
            const name = prompt("Nombre de la Playlist:");
            if (name) {
                if (!appConfig.data.playlists) appConfig.data.playlists = [];
                appConfig.data.playlists.push({name: name, songs: []});
                saveData();
                updateUI();
                showToast("Playlist creada", 'success');
            }
        };

        window.do_create_album = async function() {
            const name = document.getElementById('newAlbName').value.trim();
            if (!name) return showToast("Falta nombre", 'error');
            
            const cover = document.getElementById('newAlbCoverUrl').value || DEFAULT_COVER;
            appConfig.data.albums.push({
                title: name,
                artist: document.getElementById('newAlbArtist').value,
                cover: cover
            });
            
            await saveData();
            showToast("√Ålbum creado", 'success');
            updateUI();
            closeModal('dom_modal_album');
        };

        window.editAlbum = function(e, index) {
            e.stopPropagation();
            const album = appConfig.data.albums[index];
            appConfig.editingAlbumIndex = index;
            
            document.getElementById('editAlbName').value = album.title || album.name || '';
            document.getElementById('editAlbArtist').value = album.artist || '';
            document.getElementById('editAlbCover').value = album.cover || '';
            
            openModal('dom_modal_edit_album');
        };

        window.doSaveEditAlbum = async function() {
            const idx = appConfig.editingAlbumIndex;
            if (idx === null) return;
            
            const cover = document.getElementById('editAlbCover').value || appConfig.data.albums[idx].cover;
            appConfig.data.albums[idx] = {
                ...appConfig.data.albums[idx],
                title: document.getElementById('editAlbName').value,
                artist: document.getElementById('editAlbArtist').value,
                cover: cover
            };
            
            await saveData();
            showToast("Actualizado", 'success');
            updateUI();
            closeModal('dom_modal_edit_album');
        };

        window.deleteAlbum = async function(e, i) {
            e.stopPropagation();
            if (!confirm("¬øEliminar este √°lbum?")) return;
            
            appConfig.data.albums.splice(i, 1);
            await saveData();
            updateUI();
            showToast("√Ålbum eliminado", 'success');
        };

        window.do_create_user_modal = async function() {
            const name = document.getElementById('newUser_Name').value.trim();
            const email = document.getElementById('newUser_Email').value.trim();
            const pass = document.getElementById('newUser_Pass').value;
            
            if (!name || !email || !pass) return showToast("Faltan datos", 'error');
            if (appConfig.data.users.find(u => u.email === email)) return showToast("Usuario ya existe", 'error');
            
            const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}`;
            appConfig.data.users.push({
                id: Date.now(),
                name,
                email,
                password: pass,
                role: 'user',
                avatar: avatarUrl
            });
            
            await saveData();
            showToast("Usuario registrado", 'success');
            closeModal('dom_modal_new_user');
            updateUI();
        };

        function renderUserList(id, users) {
            const c = document.getElementById(id);
            if (!c) return;
            c.innerHTML = '';
            
            users.forEach((u, index) => {
                const div = document.createElement('div');
                div.className = 'user-list-item';
                div.innerHTML = `
                    <div class="user-info">
                        <img src="${u.avatar || DEFAULT_COVER}" style="width:30px;height:30px;border-radius:50%;margin-right:10px;object-fit:cover">
                        <span>${u.name}</span>
                        <span style="font-size:0.75rem; color:#888; margin-left:5px;">${u.role}</span>
                    </div>
                    <div style="display:flex;gap:5px">
                        <button class="btn-delete-user" onclick="deleteUser(${index})">
                            <span class="material-icons-round">delete</span>
                        </button>
                    </div>
                `;
                c.appendChild(div);
            });
        }

        window.deleteUser = async function(i) {
            if (!confirm("¬øEliminar este usuario?")) return;
            appConfig.data.users.splice(i, 1);
            await saveData();
            updateUI();
            showToast("Usuario eliminado", 'success');
        };

        function filterSongs(query) {
            const target = norm(query);
            const filtered = appConfig.data.songs.filter(s => 
                norm(s.title).includes(target) || 
                norm(s.genre).includes(target) || 
                norm(s.album).includes(target)
            );
            renderSongList(appConfig.isAdmin ? 'adminSongList' : 'userSongList', filtered);
        }

        async function saveData() {
            try {
                await fetch(`${API_BASE_URL}${PERMANENT_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': PERMANENT_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appConfig.data)
                });
            } catch(e) {
                console.error('Save error:', e);
                showToast("Error al guardar", 'error');
            }
        }

        async function saveDataSilent() {
            try {
                await fetch(`${API_BASE_URL}${PERMANENT_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': PERMANENT_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(appConfig.data)
                });
            } catch(e) {
                console.error('Silent save error:', e);
            }
        }

        window.previewFile = function(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).value = e.target.result;
                showToast("Imagen lista", 'success');
            };
            reader.readAsDataURL(file);
        };

        window.openProfile = function() {
            if (!appConfig.user) return;
            
            document.getElementById('profileName').value = appConfig.user.name;
            document.getElementById('profileEmail').value = appConfig.user.email;
            document.getElementById('profilePreview').src = appConfig.user.avatar || ADMIN_AVATAR;
            
            openModal('dom_modal_profile');
        };

        window.changeAvatar = function() {
            appConfig.user.avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.floor(Math.random() * 999)}`;
            document.getElementById('profilePreview').src = appConfig.user.avatar;
        };

        window.do_save_profile = async function() {
            const idx = appConfig.data.users.findIndex(u => u.email === appConfig.user.email);
            if (idx !== -1) {
                appConfig.data.users[idx].name = document.getElementById('profileName').value;
                appConfig.data.users[idx].avatar = appConfig.user.avatar;
                appConfig.user.name = document.getElementById('profileName').value;
                
                await saveData();
                localStorage.setItem('appConfig', JSON.stringify({
                    user: appConfig.user,
                    isLoggedIn: true,
                    isAdmin: appConfig.isAdmin
                }));
                
                closeModal('dom_modal_profile');
                showToast("Perfil actualizado", 'success');
                updateUI();
            }
        };

        window.do_save_announce = async function() {
            appConfig.data.announcement = document.getElementById('announcementInput').value;
            await saveData();
            updateUI();
            closeModal('dom_modal_announcement');
            showToast("Noticia publicada", 'success');
        };

        window.applyDateFilter = function() {
            const start = document.getElementById('filterStart').value;
            const end = document.getElementById('filterEnd').value;
            
            if (!start || !end) {
                showToast("Selecciona ambas fechas", 'error');
                return;
            }
            
            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime();
            
            const filtered = appConfig.data.songs.filter(s => {
                return s.id >= startDate && s.id <= endDate;
            });
            
            updateUI(filtered);
            closeModal('dom_modal_date_filter');
            showToast(`${filtered.length} canciones encontradas`, 'info');
        };

        window.clearDateFilter = function() {
            updateUI();
            closeModal('dom_modal_date_filter');
            showToast("Filtro eliminado", 'info');
        };

        window.app_logout = () => {
            if (dom.audioElement) dom.audioElement.pause();
            const mainPlayer = document.getElementById('mainPlayer');
            if (mainPlayer) mainPlayer.style.display = 'none';
            localStorage.removeItem('appConfig');
            location.reload();
        };

        window.openModal = (id) => {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'flex';
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'none';
        };

        window.switchTab = (id, btn) => {
            document.querySelectorAll('.list-tab-content, .tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            updateUI();
        };

        function activateGuestMode() {
            console.log('Activando modo invitado para canci√≥n:', appConfig.pendingSongId);
            const song = appConfig.data.songs.find(s => s.id === appConfig.pendingSongId);
            if (song) {
                appConfig.tempPlaylist = [song];
                appConfig.currentIndex = 0;
                playSong(song);
                openFullScreenPlayer();
                
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-admin').style.display = 'none';
                document.getElementById('view-user').style.display = 'none';
                
                const mainPlayer = document.getElementById('mainPlayer');
                if (mainPlayer) mainPlayer.style.display = 'none';
            } else {
                showToast("Canci√≥n no encontrada", 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('MusiChris App iniciando...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('s');
            if (sharedId) {
                appConfig.pendingSongId = parseInt(sharedId);
                appConfig.isGuest = true;
            }
            
            dom.audioElement = document.createElement('audio');
            dom.audioElement.id = 'audioElement';
            document.body.appendChild(dom.audioElement);
            
            dom.audioElement.addEventListener('play', () => togglePlayIcon(true));
            dom.audioElement.addEventListener('pause', () => togglePlayIcon(false));
            dom.audioElement.addEventListener('timeupdate', updateProgress);
            dom.audioElement.addEventListener('ended', () => {
                togglePlayIcon(false);
                next();
            });
            dom.audioElement.addEventListener('error', (e) => {
                console.error("Audio error:", e);
                showToast("Error de audio", 'error');
                togglePlayIcon(false);
            });
            
            const btnLoginBtn = document.getElementById('btnLoginBtn');
            if (btnLoginBtn) {
                btnLoginBtn.addEventListener('click', handleLoginAttempt);
            }
            
            const loginPass = document.getElementById('loginPass');
            if (loginPass) {
                loginPass.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLoginAttempt();
                });
            }
            
            const btnTogglePass = document.getElementById('btnTogglePass');
            if (btnTogglePass) {
                btnTogglePass.addEventListener('click', function() {
                    const passInput = document.getElementById('loginPass');
                    if (passInput.type === 'password') {
                        passInput.type = 'text';
                        this.textContent = 'visibility';
                    } else {
                        passInput.type = 'password';
                        this.textContent = 'visibility_off';
                    }
                });
            }
            
            const seekSlider = document.getElementById('seekSlider');
            if (seekSlider) {
                seekSlider.addEventListener('input', seekAudio);
            }
            
            const searchInputAdmin = document.getElementById('searchInputAdmin');
            if (searchInputAdmin) {
                searchInputAdmin.addEventListener('keyup', (e) => filterSongs(e.target.value));
            }
            
            const searchInputUser = document.getElementById('searchInputUser');
            if (searchInputUser) {
                searchInputUser.addEventListener('keyup', (e) => filterSongs(e.target.value));
            }
            
            appConfig.BIN_ID = PERMANENT_BIN_ID;
            appConfig.API_KEY = PERMANENT_API_KEY;
            
            if (appConfig.isGuest) {
                loadAppData();
            } else {
                const saved = localStorage.getItem('appConfig');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        appConfig.user = parsed.user;
                        appConfig.isLoggedIn = parsed.isLoggedIn;
                        appConfig.isAdmin = parsed.isAdmin;
                    } catch(e) {
                        console.error('Error parsing saved config:', e);
                    }
                }
                
                if (appConfig.isLoggedIn && appConfig.user) {
                    showView(appConfig.isAdmin ? 'view-admin' : 'view-user');
                    loadAppData();
                } else {
                    document.getElementById('view-login').style.display = 'flex';
                }
            }
        });
    </script>
</body>
</html>('hidden');
            }
            
            const art = getSongArt(song);
            
            if (document.getElementById('pTitle')) 
                document.getElementById('pTitle').textContent = song.title;
            if (document.getElementById('pArtist')) 
                document.getElementById('pArtist').textContent = song.genre;
            if (document.getElementById('pCoverMini')) 
                document.getElementById('pCoverMini').src = art;
            
            updateLikeIcon();
            
            if (dom.audioElement && song.url) {
                dom.audioElement.pause();
                dom.audioElement.src = song.url;
                dom.audioElement.load();
                
                dom.audioElement.play()
                    .then(() => {
                        console.log('Playing...');
                        togglePlayIcon(true);
                    })
                    .catch(err => {
                        console.error('Play error:', err);
                        showToast("Error al reproducir", 'error');
                        togglePlayIcon(false);
                    });
            }
            
            const idx = appConfig.data.songs.findIndex(s => s.id === song.id);
            if (idx !== -1) {
                if (!appConfig.data.songs[idx].plays) appConfig.data.songs[idx].plays = 0;
                appConfig.data.songs[idx].plays++;
                saveDataSilent();
            }
        }

        function togglePlayIcon(isPlaying) {
            const txt = isPlaying ? 'pause' : 'play_arrow';
            if (document.getElementById('iconPlay')) 
                document.getElementById('iconPlay').textContent = txt;
            const iconBig = document.getElementById('iconPlayBig');
            if (iconBig) iconBig.textContent = txt;
            const iconMin = document.getElementById('iconPlayMin');
            if (iconMin) iconMin.textContent = txt;
        }

        window.toggle_play = () => {
            if (!dom.audioElement) return;
            if (dom.audioElement.paused) {
                dom.audioElement.play().catch(err => console.error('Play error:', err));
            } else {
                dom.audioElement.pause();
            }
        };

        window.toggleShuffle = () => {
            appConfig.isShuffle = !appConfig.isShuffle;
            showToast(appConfig.isShuffle ? "Aleatorio activado" : "Aleatorio desactivado", 'info');
        };

        window.toggleRepeat = () => {
            appConfig.isRepeat = !appConfig.isRepeat;
            showToast(appConfig.isRepeat ? "Repetir activado" : "Repetir desactivado", 'info');
        };

        window.prev = () => {
            if (appConfig.isGuest) {
                showToast("Solo puedes reproducir esta canci√≥n", 'info');
                return;
            }
            
            if (appConfig.currentIndex > 0) {
                appConfig.currentIndex--;
                playSong(appConfig.tempPlaylist[appConfig.currentIndex]);
            } else {
                showToast("Primera canci√≥n", 'info');
            }
        };

        window.next = () => {
            if (appConfig.isGuest) {
                showToast("Solo puedes reproducir esta canci√≥n", 'info');
                return;
            }
            
            if (appConfig.isShuffle) {
                const randomIndex = Math.floor(Math.random() * appConfig.tempPlaylist.length);
                appConfig.currentIndex = randomIndex;
                playSong(appConfig.tempPlaylist[randomIndex]);
            } else if (appConfig.currentIndex < appConfig.tempPlaylist.length - 1) {
                appConfig.currentIndex++;
                playSong(appConfig.tempPlaylist[appConfig.currentIndex]);
            } else if (appConfig.isRepeat) {
                appConfig.currentIndex = 0;
                playSong(appConfig.tempPlaylist[0]);
            } else {
                showToast("√öltima canci√≥n", 'info');
            }
        };

        window.openFullScreenPlayer = function() {
            if (!appConfig.currentSong) return;
            
            document.getElementById('view-guest-player').style.display = 'flex';
            const mainPlayer = document.getElementById('mainPlayer');
            if (mainPlayer) mainPlayer.classList.add('hidden');
            
            document.getElementById('guestTitle').textContent = appConfig.currentSong.title;
            document.getElementById('guestArtist').textContent = appConfig.currentSong.genre;
            document.getElementById('guestCover').style.backgroundImage = `url('${getSongArt(appConfig.currentSong)}')`;
            
            const area = document.querySelector('.guest-info-area');
            area.querySelectorAll('.progress-container').forEach(e => e.remove());
            
            const d = document.createElement('div');
            d.className = 'progress-container';
            d.innerHTML = `
                <span id="expCurTime" class="time-display">0:00</span>
                <input type="range" id="expandedSeekSlider" value="0" max="100">
                <span id="expTotTime" class="time-display">0:00</span>
            `;
            area.appendChild(d);
            
            document.getElementById('expandedSeekSlider').addEventListener('input', seekAudio);
            
            const ctrls = document.querySelector('.guest-controls-main');
            ctrls.innerHTML = `
                <span class="material-icons-round btn-guest-action" onclick="toggleShuffle()" style="font-size:1.3rem;">shuffle</span>
                <span class="material-icons-round btn-guest-action" style="font-size:2.5rem" onclick="prev()">skip_previous</span>
                <span class="material-icons-round btn-guest-action" id="iconPlayBig" style="font-size:3.5rem" onclick="toggle_play()">pause</span>
                <span class="material-icons-round btn-guest-action" style="font-size:2.5rem" onclick="next()">skip_next</span>
                <span class="material-icons-round btn-guest-action" onclick="toggleRepeat()" style="font-size:1.3rem;">repeat</span>
            `;
        };

        window.closeFullScreenPlayer = function() {
            document.getElementById('view-guest-player').style.display = 'none';
            const mainPlayer = document.getElementById('mainPlayer');
            if (mainPlayer) mainPlayer.classList.remove('hidden');
        };

        window.closeGuestMode = function() {
            if (appConfig.isGuest) {
                if (confirm("¬øDeseas iniciar sesi√≥n en MusiChris?")) {
                    if (dom.audioElement) {
                        dom.audioElement.pause();
                    }
                    document.getElementById('view-guest-player').style.display = 'none';
                    document.getElementById('view-login').style.display = 'flex';
                    appConfig.isGuest = false;
                    appConfig.currentSong = null;
                }
            } else {
                closeFullScreenPlayer();
            }
        };

        window.closePlayer = function() {
            const mainPlayer = document.getElementById('mainPlayer');
            if (mainPlayer) {
                mainPlayer.style.display = 'none';
                mainPlayer.classList.remove





